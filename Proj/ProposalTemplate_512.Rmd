---
title: "512 Project Part I"
output:
  word_document:
    fig_height: 5
    fig_width: 8
date: "Due Sept 27"
author: "Jared Adam"
---
**The number of conflicts with dplyr from all of the packages we must download is becoming annoying and breaking code.** 

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)
options(show.signif.stars = FALSE)

library(lme4)
library(ggplot2)
library(ggthemes)
library(tidyverse)
library(car)
library(effects)
library(mosaic)
library(ggResidpanel)
library(catstats2)
library(effects)
library(gtsummary)
library(modelsummary)
library(ggpp)
library(multcomp)
library(emmeans)
theme_set(theme_bw()) #Prevents need for + theme_bw() in ggplots
```

# Part I (512 only, project proposal, 25 pts): 

1) Read in your data set and run `dim` on it:

```{r}
set.seed(654321)
s21 <- read_csv('data/2021 Sentinel Prey Assessment.csv')
s22 <- read_csv("data/PSA_CE2_SentinelPrey.csv")
s23 <- read_csv('data/PSA_Sent.prey.2023.csv')

# I need to get total predation into a column as a binary. 1 = predation, 0 = not

# 2021 cleaning 
s21
clean21 <- s21 %>% 
  mutate(year = '2021') %>% 
  dplyr::select(location, year, growth_stage, plot_id, rep.block, treatment, to.predated) %>% 
  mutate(to.predated = as.double(to.predated)) %>% 
  dplyr::rename(block = rep.block) %>% 
  group_by(location, year, growth_stage, plot_id, block, treatment) %>% 
  # dplyr::summarise(total = sum(to.predated)) %>% 
  na.omit() %>% 
  mutate(treatment = case_when(
    treatment == '33' ~ '3',
    .default = as.factor(treatment))) %>% 
  dplyr::filter(treatment != '6',
                treatment != '7',
                treatment != '8') %>% 
  mutate_at(vars(1:6), as.factor) 


# 2022 cleaning 
s22
unique(s22$treatment)
unique(s22$growth_stage)
clean22 <- s22 %>% 
  mutate(year = '2022') %>% 
  dplyr::select(location, year, growth_stage, plotid, block, treatment, to.predated) %>% 
  dplyr::rename(plot_id = plotid) %>% 
  mutate(growth_stage = case_when(growth_stage == 'R2' ~ 'R3',
                                  .default = as.character(growth_stage))) %>% 
  dplyr::group_by(location, year, growth_stage, plot_id, block, treatment) %>% 
  # dplyr::summarise(total = sum(to.predated)) %>% 
  mutate_at(vars(1:6), as.factor)


# 2023 cleaning 

clean23 <- s23 %>%
  mutate(year = '2023') %>%
  relocate(am.partial, am.absent, pm.partial, pm.absent) %>% 
  mutate_at(vars(1:4), as.double) %>% 
  mutate(to.predated = if_else(am.partial | am.absent | pm.partial | pm.absent == 1, 1, 0)) %>% 
  relocate(to.predated)%>%  
  mutate(growth_stage = case_when((location == 'NC' & date == '7/20/2023') ~ 'R3',
                                  .default = as.character(growth_stage))) %>%  
  dplyr::select(location, year, growth_stage, plotid, block, treatmetn, to.predated) %>% 
  dplyr::rename(plot_id = plotid, 
         treatment = treatmetn) %>%
  distinct() %>% 
  group_by(location, year, growth_stage, plot_id, block, treatment) %>% 
  na.omit() %>% 
  filter(treatment != 5) %>% 
  mutate_at(vars(1:6),as.factor)

# and in the darkness, bind them 
sent <- rbind(clean21, clean22, clean23)
as_tibble(sent)
dim(sent)

```


2) Prepare a short description of your data set (source if published paper exists), especially providing the study design, sample size, and variables of primary interest. If there is random sampling, note the population sampled from. If there is random assignment, note how and for which variable(s).

Data: Sentinel Prey assessment of arthropod-predator activity in corn fields. 

These data come from the Precision Sustainable Agriculture effort through the USDA. I am the lead on the entomology component of this project and responsible for analyzing this three year data set which spans multiple states. This effort began during my Master's degree, but I only analyzed Pennsylvania data for my thesis. 

**Study design: **
**Treatments** = 4; No cover crop, early-terminated cover crop, late-terminated cover crop, planting green
**Plots** = 20; 5 blocks composed of 4 plots each = 20 plots / study site / year
**Years** = 3 (2021,2022,2023)
**Locations** = This project comprises 16 states. Not all states collected sentinel prey data every year. Each site year was in a different field. 
**Effort** = Data were collected at three corn growth stages / year (V3,V5,R3).
**Sample** = 6 sentinel prey traps were placed in each plot = 120 samples collected / growth stage. Total sample effort per state per season = 360 samples. 

**Variables:**
**Response** = Total level of predation. This is a binomial of 6 traps/ counts per plot. Pseudoreplication is account for in the random term. 
**Explanatory** = Crop growth stage (timing, three levels) and treatment (four levels). I am not interested in the fixed effects of location. 
**Random effects** = Plot in block in location, in year. I want to account for pseduoreplication and all of the site/year combinations.

Plots were randomly assigned to each block. Field sites were as random as they could be at each respective research station. Sentinel prey traps were placed between pre-determined rows and at specific length intervals within each plot to maintain consistency. 

3) Make a `missing_data.frame` plot of your data set and explain any missing values indicated:

```{r}
library(mi)
# make an object of the missing df and then present the image
tdf <- missing_data.frame(data.frame(sent))
image(tdf)

```



4) Discuss any other use in classes or theses for the data - either that you have used it for or are currently working on for future submissions.

**I am working on this for a publication. There is no published paper yet. None of the code from that is used here. This analysis is for all of the states combined, but in the future, I plan to run each state individually with their three years of data. I suspect results to differ based on some regional grouping (e.g., growing degree days, growth region, etc.), but am yet to decide what I will use. For now, I am mainly interested in the treatment and growth stage effects on the whole data set. **

5) Provide at least one display of the data, focusing on the response of interest versus a predictor. If you have multiple predictors, try to plot the response versus those too.

```{r}

library(ggmosaic)
sent %>% 
  ggplot() +
  geom_mosaic(aes(x = product(treatment), fill = to.predated))+
  facet_wrap(~growth_stage)+
  scale_fill_colorblind()+
  labs(title = 'Mosaic plot of Predation by Treatment and Growth Stage',
       y = 'Density',
       x = ' Treatment')


```


6) Provide an initial model you hope to fit (does not need to be fit). If you fit a model, add a model summary and effects plot.

```{r}
sent

m2 <- glmer(to.predated ~ treatment*growth_stage + (1|year/location/block/plot_id) , family = binomial, data = sent)
summary(m2)

Anova(m2)

plot(allEffects(m2), type = 'link',ylab = 'estimated log differnces in total predation', grid = T)
plot(allEffects(m2), type = 'response', ylab = 'estimated probability differnces in total predation', grid = T)



```
* There is weak evidence against the null of no interaction between treatment and growth stage Chi squared(6) = 4.13, p = 0.6591, after controlling for the random effect of plot nested in block nested in location nested in year, and will remove the interaction term from the model. 

**Model refinement**

```{r}
m3 <- glmer(to.predated ~ treatment+growth_stage + (1|year/location/block/plot_id) , family = binomial, data = sent)
summary(m3)

Anova(m3)

cld(emmeans(m3, ~treatment), Letters = letters)
cld(emmeans(m3, ~growth_stage), Letters = letters)

```

```{r}
sent %>% 
  ggplot()+
  geom_mosaic(aes(x = product(treatment), fill = to.predated))+
  scale_fill_manual(values = c("#E7298A","#1B9E77"))+
  scale_x_productlist(labels=c("No CC", "Early", "Late", "Green"))+
  labs(title = 'Whole Team Sentinel Prey ~ Treatment',
       x = 'Treatment',
       y = 'Total predation binary',
       caption = 'Total predation binary where 1 = predation and 0 = no predation.\nPredation levels differed between the no-cover and late-terminated treatment\nand the no-cover and planting-green treatment (p < 0.05).\nCompact letter display denotes differences among treatments.')+
  theme(legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size = 16),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 12), 
        panel.grid.major.y = element_line(color = "darkgrey"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(size = 12),
        plot.caption = element_text(hjust = 0, size = 12, color = "grey25"),
        axis.ticks.length=unit(.25, "cm"))+
  annotate('text', x = 0.15, y = 0.95, label = 'a', size = 8)+
  annotate('text', x = .4, y = 0.95, label = 'ab', size = 8)+
  annotate('text', x = .65, y = 0.95, label = 'bc', size = 8)+
  annotate('text', x = .875, y = 0.95, label = 'c', size = 8)


sent %>% 
  ggplot()+
  geom_mosaic(aes(x = product(growth_stage), fill = to.predated))+
  scale_fill_manual(values = c("#E7298A","#1B9E77"))+
  labs(title = 'Whole Team Sentinel Prey ~ Growth Stage',
       x = 'Growth Stage',
       y = 'Total predation binary',
       caption = 'Total predation binary where 1 = predation and 0 = no predation.\nPredation levels differed among all growth stages (p < 0.05), where R3 was the highest, followed by V5, and then V3.\nCompact letter display denotes differences among treatments.')+
  theme(legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        axis.text.x = element_text(size=16),
        axis.text.y = element_text(size = 16),
        axis.title = element_text(size = 18),
        plot.title = element_text(size = 18),
        plot.subtitle = element_text(size = 12), 
        panel.grid.major.y = element_line(color = "darkgrey"),
        panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text = element_text(size = 12),
        plot.caption = element_text(hjust = 0, size = 12, color = "grey25"),
        axis.ticks.length=unit(.25, "cm"))+
  annotate('text', x = 0.175, y = 0.95, label = 'a', size = 8)+
  annotate('text', x = .5, y = 0.95, label = 'b', size = 8)+
  annotate('text', x = .85, y = 0.95, label = 'c', size = 8)

```

* Used https://haleyjeppson.github.io/ggmosaic/reference/geom_mosaic.html for the scale_x_productlist function. 

**How to I reorder my x axis? I was not able to find the syntax online. I tried limits, but it seems limits in the scale_x_productlist does not work like it does in scale_x_discrete. 

7) Start to work on a Table 1 that summarizes variables of interest, possibly by groups of interest. At a minimum, summarize the response variable, by a grouping variable if one exists. 

```{r}
# table as a proportion 
sent %>% 
  group_by(location, treatment, growth_stage) %>% 
  summary()

sent %>% 
  group_by(growth_stage) %>% 
  summary()


tally(treatment ~ growth_stage, data = sent)

```

8) Research question: 

How does sentinel prey rates (1,0) change among treatments and between growth stages and is there an interaction between treatment and growth stage? 

10) SOI 

